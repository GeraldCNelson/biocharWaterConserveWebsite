<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biochar Project</title>

    <!-- Stylesheets -->
    <link href="static/css/bootstrap.min.css" rel="stylesheet">
    <link href="static/css/styles.css" rel="stylesheet">

    <!-- JavaScript Dependencies -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="static/js/bootstrap.bundle.min.js" defer></script>

    <style>
    .control-panel {
        width: 100%;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .plot-panel {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .graph-container {
        width: 100%;
        height: 400px; /* Set a fixed height */
    }
</style>
</head>
<body>
<div class="container-fluid mt-4">
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" id="introduction-tab" data-bs-toggle="tab" href="#intro"
               role="tab">Introduction</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="main-data-tab" data-bs-toggle="tab" href="#main-data" role="tab">Main Data
                Display</a>
        </li>
    </ul>
    <div class="tab-content">
        <!-- Introduction Tab -->
        <div class="tab-pane fade show active" id="intro" role="tabpanel">
            <div id="intro-content" class="mt-3">Loading content...</div>
        </div>

        <!-- Main Data Display Tab -->
        <div class="tab-pane fade" id="main-data" role="tabpanel">
            <div class="row mt-3">
                <!-- Control Panel -->
                <div class="col-md-3">
                    <div class="control-panel">
                        <h4>Date Range Selection</h4>
                        <label for="year">Year:</label>
                        <select id="year" class="form-select mb-3"></select>
                        <label for="start-date">Start Date:</label>
                        <input type="date" id="start-date" class="form-control mb-3">
                        <label for="end-date">End Date:</label>
                        <input type="date" id="end-date" class="form-control mb-3">
                        <label for="strip">Strip:</label>
                        <select id="strip" class="form-select mb-3"></select>
                        <label for="variable">Variable:</label>
                        <select id="variable" class="form-select mb-3"></select>
                        <label for="depth">Depth:</label>
                        <select id="depth" class="form-select mb-3">
                            <!-- Depth options will be dynamically populated using JavaScript -->
                        </select>
                        <button id="update-plots" class="btn btn-primary w-100 mb-3">Update Plots</button>
                        <button id="download-raw" class="btn btn-secondary w-100 mb-3">Download Raw Data (CSV)</button>
                        <button id="download-ratio" class="btn btn-secondary w-100">Download Ratio Data (CSV)</button>
                    </div>
                </div>

                <!-- Graph Panels -->
                <div class="col-md-9">
                    <div class="plot-panel">
                        <div id="graph-top" class="graph-container mb-4">
                            <p class="text-muted">Raw Data Plot Placeholder</p>
                        </div>
                        <div id="graph-bottom" class="graph-container">
                            <p class="text-muted">Ratio Plot Placeholder</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main JavaScript Logic -->
<script>
/* Numbering System Summary:
1. Application Initialization
2. Populate Control Panel
3. Load Introduction Content
4. Update Plots
5. Fetch Default and Options
6. Debugging Utilities
7. Markdown Loading
8. Replace NaN with Null */

// 1. Application Initialization
async function initializeApplication() {
    console.log("Initializing application...");

    // Fetch defaults and options
    try {
        console.log("Fetching defaults and options...");
        const options = await fetchDefaultsAndOptions();
        console.log("Defaults and options fetched:", options);

        // Populate control panel
        console.log("Populating control panel with:", options);
        populateControlPanel(options);
    } catch (error) {
        console.error("Error during application initialization:", error);
        return;
    }

    // Load introduction content
    await loadIntroductionContent();

    console.log("Application initialized.");
}

// 2. Populate Control Panel
function populateControlPanel({ defaults, years, strips, variables, depths }) {
    const yearSelect = document.getElementById("year");
    const stripSelect = document.getElementById("strip");
    const variableSelect = document.getElementById("variable");
    const depthSelect = document.getElementById("depth");
    const startDateInput = document.getElementById("start-date");
    const endDateInput = document.getElementById("end-date");

    // Populate dropdowns and inputs
    years.forEach(year => {
        const option = document.createElement("option");
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    });
    strips.forEach(strip => {
        const option = document.createElement("option");
        option.value = strip;
        option.textContent = strip;
        stripSelect.appendChild(option);
    });
    variables.forEach(variable => {
        const option = document.createElement("option");
        option.value = variable;
        option.textContent = variable;
        variableSelect.appendChild(option);
    });
    depths.forEach(({ value, label }) => {
        const option = document.createElement("option");
        option.value = value;
        option.textContent = label;
        depthSelect.appendChild(option);
    });

    // Set defaults
    yearSelect.value = defaults.year;
    stripSelect.value = defaults.strip;
    variableSelect.value = defaults.variable;
    depthSelect.value = defaults.depth;
    startDateInput.value = defaults.startDate;
    endDateInput.value = defaults.endDate;

    console.log("Control panel populated successfully.");
}

// 3. Load Introduction Content
async function loadIntroductionContent() {
    console.log("Loading introduction content...");
    await loadMarkdownContent("/markdown/intro.md", "intro-content");
    console.log("Loaded intro.md content successfully.");
}

// 4. Update Plots
async function updatePlots(params) {
    console.log("Fetching plots with:", params);

    try {
        // Ensure defaults are applied
       //  params = ensureDefaults(params);
        console.log("Params after ensuring defaults:", params);

        // Fetch raw plot data
        console.log("Fetching raw plot data...");
        const rawResponse = await fetch("/plot_raw", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(params)
        });
        console.log("Raw response:", rawResponse); // Debug statement to print rawResponse

        if (rawResponse.ok) {
            let rawData = await rawResponse.json();
            rawData = replaceNaNWithNull(rawData); // Ensure NaN values are replaced
            console.log("Sanitized raw data:", rawData);
            Plotly.react("graph-top", rawData.data, rawData.layout);
            console.log("Raw plot rendered successfully.");
        } else {
            throw new Error("Failed to load raw plot data.");
        }

        // Fetch ratio plot data
        console.log("Fetching ratio plot data...");
        const ratioResponse = await fetch("/plot_ratio", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(params)
        });

        if (ratioResponse.ok) {
            let ratioData = await ratioResponse.json();
            ratioData = replaceNaNWithNull(ratioData); // Ensure NaN values are replaced
            console.log("Sanitized ratio data:", ratioData);
            Plotly.react("graph-bottom", ratioData.data, ratioData.layout);
            console.log("Ratio plot rendered successfully.");
        } else {
            throw new Error("Failed to load ratio plot data.");
        }
    } catch (error) {
        console.error("Error fetching or rendering plots:", error);
    }
}

// 5. Fetch Defaults and Options
async function fetchDefaultsAndOptions() {
    const response = await fetch("/get_defaults_and_options");
    if (!response.ok) {
        throw new Error("Failed to fetch defaults and options.");
    }
    return response.json();
}

// 6. Debugging Utilities
function logError(message, error) {
    console.error(message, error);
}

// 7. Markdown Loading
async function loadMarkdownContent(filePath, elementId) {
    console.log(`Loading markdown content from ${filePath} into element #${elementId}...`);
    try {
        const response = await fetch(filePath);
        const markdownText = await response.text();
        document.getElementById(elementId).innerHTML = marked.parse ? marked.parse(markdownText) : marked(markdownText);
        console.log(`Loaded markdown content for ${elementId} successfully.`);
    } catch (error) {
        logError(`Error loading markdown content for ${elementId} from ${filePath}:`, error);
    }
}

// 8. Replace NaN with Null
function replaceNaNWithNull(obj) {
    if (Array.isArray(obj)) {
        return obj.map(replaceNaNWithNull);
    } else if (obj !== null && typeof obj === "object") {
        return Object.fromEntries(
            Object.entries(obj).map(([key, value]) => [key, replaceNaNWithNull(value)])
        );
    } else if (Number.isNaN(obj)) {
        return null;
    }
    return obj;
}

// Application entry point
document.addEventListener("DOMContentLoaded", initializeApplication);
document.getElementById("update-plots").addEventListener("click", () => {
    const params = {
        year: document.getElementById("year").value,
        startDate: document.getElementById("start-date").value,
        endDate: document.getElementById("end-date").value,
        strip: document.getElementById("strip").value,
        variable: document.getElementById("variable").value,
        depth: document.getElementById("depth").value
    };
    updatePlots(params);
});
</script>

</body>
</html>